<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Branch Management</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  {% include "_admin_nav.html" %}
  
  <main class="admin-wrap">
    <header class="admin-header">
      <h2 class="hello welcome-text">BRANCH MANAGEMENT</h2>
    </header>

    <!-- Statistics Cards -->
    <section class="card stats-card">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">TOTAL BRANCHES</div>
          <div class="stat-value" id="totalBranches">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-title">VISITED</div>
          <div class="stat-value" id="visitedBranches">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-title">UNVISITED</div>
          <div class="stat-value" id="unvisitedBranches">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-title">HEADQUARTERS</div>
          <div class="stat-value" id="hqCount">0</div>
        </div>
      </div>
    </section>

    <!-- Add Branch Section -->
    <section class="card">
      <h3 class="section-header">Add New Branch</h3>
      
      <div id="branchMessage"></div>

      <div class="branch-form-grid">
        <div class="form-section">
          <h4>Branch Details</h4>
          <div class="form-fields">
            <input type="text" id="branchName" placeholder="Branch Name *">
            <input type="text" id="branchAddress" placeholder="Address (optional)">
            
            <div class="coordinate-grid">
              <input type="number" id="branchLat" step="any" placeholder="Latitude *">
              <input type="number" id="branchLng" step="any" placeholder="Longitude *">
            </div>
            
            <label class="checkbox-label">
              <input type="checkbox" id="isHQ">
              <span>Mark as Headquarters</span>
            </label>
            
            <button onclick="addBranch()" class="btn-primary">Add Branch</button>
          </div>
        </div>
        
        <div class="tips-box">
          <h4>üí° Tips</h4>
          <ul>
            <li>Use Google Maps to find accurate coordinates</li>
            <li>Only one branch can be marked as HQ</li>
            <li>Address is optional but recommended</li>
            <li>Coordinates should be in decimal format</li>
            <li>‚ö†Ô∏è HQ cannot be deleted if it's the only one</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Branch Filters -->
    <section class="card">
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all" onclick="filterBranches('all', event)">
          All Branches (<span id="countAll">0</span>)
        </button>
        <button class="filter-tab" data-filter="visited" onclick="filterBranches('visited', event)">
          Visited (<span id="countVisited">0</span>)
        </button>
        <button class="filter-tab" data-filter="unvisited" onclick="filterBranches('unvisited', event)">
          Unvisited (<span id="countUnvisited">0</span>)
        </button>
        <button class="filter-tab" data-filter="hq" onclick="filterBranches('hq', event)">
          Headquarters (<span id="countHQ">0</span>)
        </button>
      </div>

      <!-- Branches Table -->
      <div class="table-wrap">
        <table class="auditors-table">
          <thead>
            <tr>
              <th>Branch Name</th>
              <th>Type</th>
              <th>Address</th>
              <th>Coordinates</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="branchTableBody">
            <tr><td colspan="6" style="text-align: center; padding: 20px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    let allBranches = [];
    let currentFilter = 'all';

    async function loadBranches() {
      try {
        console.log('Fetching branches from /api/branches...');
        const res = await fetch('/api/branches');
        const data = await res.json();
        
        console.log('API Response:', data);
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load branches');
        }
        
        allBranches = data.branches || [];
        console.log('Loaded branches:', allBranches);
        
        updateStats();
        renderBranches(currentFilter);
        
      } catch (err) {
        console.error('Error loading branches:', err);
        showMessage('error', 'Error loading branches: ' + err.message);
        document.getElementById('branchTableBody').innerHTML = 
          '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #dc3545;">Failed to load branches: ' + err.message + '</td></tr>';
      }
    }

    function updateStats() {
      const total = allBranches.length;
      const hq = allBranches.filter(b => b.is_hq).length;
      const visited = allBranches.filter(b => b.visited && !b.is_hq).length;
      const unvisited = allBranches.filter(b => !b.visited && !b.is_hq).length;
      
      console.log('Stats:', { total, hq, visited, unvisited });
      
      document.getElementById('totalBranches').textContent = total;
      document.getElementById('visitedBranches').textContent = visited;
      document.getElementById('unvisitedBranches').textContent = unvisited;
      document.getElementById('hqCount').textContent = hq;
      
      // Update filter counts
      document.getElementById('countAll').textContent = total;
      document.getElementById('countVisited').textContent = visited;
      document.getElementById('countUnvisited').textContent = unvisited;
      document.getElementById('countHQ').textContent = hq;
    }

    function filterBranches(filter, event) {
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      currentFilter = filter;
      renderBranches(filter);
    }

    function renderBranches(filter) {
      let filtered = allBranches;
      
      switch (filter) {
        case 'visited':
          filtered = allBranches.filter(b => b.visited && !b.is_hq);
          break;
        case 'unvisited':
          filtered = allBranches.filter(b => !b.visited && !b.is_hq);
          break;
        case 'hq':
          filtered = allBranches.filter(b => b.is_hq);
          break;
        default:
          filtered = allBranches;
      }
      
      console.log(`Filter: ${filter}, Showing ${filtered.length} branches`);
      
      const tbody = document.getElementById('branchTableBody');
      
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">
          No branches found for "${filter}" filter.
          ${allBranches.length === 0 ? '<br><br>Add your first branch using the form above.' : ''}
        </td></tr>`;
        return;
      }
      
      tbody.innerHTML = filtered.map(branch => {
        const canDelete = !branch.is_hq || allBranches.filter(b => b.is_hq).length > 1;
        
        return `
          <tr>
            <td><strong>${escapeHtml(branch.name)}</strong></td>
            <td>
              <span class="badge ${branch.is_hq ? 'badge-hq' : 'badge-branch'}">
                ${branch.is_hq ? 'üè¢ HQ' : 'üìç Branch'}
              </span>
            </td>
            <td>${branch.address ? escapeHtml(branch.address) : '<span class="empty-text">No address</span>'}</td>
            <td class="coordinates">${Number(branch.lat).toFixed(4)}, ${Number(branch.lng).toFixed(4)}</td>
            <td>
              <span class="badge ${branch.visited ? 'badge-visited' : 'badge-unvisited'}">
                ${branch.visited ? '‚úÖ Visited' : '‚è≥ Unvisited'}
              </span>
            </td>
            <td>
              ${canDelete 
                ? `<button class="delete-btn" onclick="deleteBranch(${branch.id}, '${escapeHtml(branch.name)}')">Delete</button>`
                : `<button class="delete-btn" disabled title="Cannot delete the only headquarters">Delete</button>`
              }
            </td>
          </tr>
        `;
      }).join('');
    }

    async function addBranch() {
      const name = document.getElementById('branchName').value.trim();
      const address = document.getElementById('branchAddress').value.trim();
      const lat = parseFloat(document.getElementById('branchLat').value);
      const lng = parseFloat(document.getElementById('branchLng').value);
      const isHQ = document.getElementById('isHQ').checked;
      
      if (!name) return showMessage('error', 'Branch name is required');
      if (isNaN(lat) || isNaN(lng)) return showMessage('error', 'Valid coordinates are required');
      
      try {
        const res = await fetch('/admin/add-branch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, address, lat, lng, is_hq: isHQ ? 1 : 0 })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showMessage('success', 'Branch added successfully');
          clearForm();
          await loadBranches();
        } else {
          showMessage('error', data.error || 'Failed to add branch');
        }
      } catch (err) {
        showMessage('error', 'Error: ' + err.message);
      }
    }

    async function deleteBranch(id, name) {
      if (!confirm(`Delete branch "${name}"? This cannot be undone.`)) return;
      
      try {
        const res = await fetch(`/admin/delete-branch/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          showMessage('success', 'Branch deleted successfully');
          await loadBranches();
        } else {
          showMessage('error', data.error || 'Failed to delete branch');
        }
      } catch (err) {
        showMessage('error', 'Error: ' + err.message);
      }
    }

    function clearForm() {
      document.getElementById('branchName').value = '';
      document.getElementById('branchAddress').value = '';
      document.getElementById('branchLat').value = '';
      document.getElementById('branchLng').value = '';
      document.getElementById('isHQ').checked = false;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    function showMessage(type, text) {
      const msg = document.getElementById('branchMessage');
      msg.className = `message ${type}`;
      msg.textContent = text;
      setTimeout(() => { msg.textContent = ''; msg.className = ''; }, 5000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded, loading branches...');
      loadBranches();
    });
  </script>
</body>
</html>