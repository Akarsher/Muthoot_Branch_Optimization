<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Planned Route Map</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    #map { width:100%; height:100vh; }
    .map-overlay {
      position: fixed; left:12px; top:12px; z-index:1000;
      background:#fff; padding:8px 10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }
    .map-warning { color:#c82333; font-weight:600; }
  </style>
</head>
<body>
  <div class="map-overlay">
    <a href="{{ url_for('route_optimization') }}">← Back to Planning</a>
    <div id="map-info" style="margin-top:6px;"></div>
  </div>

  <div id="map"></div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

  <script>
    // stops injected by Flask
    const stops = {{ stops | tojson | safe }};
    const dayNumber = {{ day_number|default(1) }};

    // friendly message when no planned route present
    if (!stops || stops.length < 2) {
      document.getElementById('map-info').innerHTML = '<div class="map-warning">No planned route for day ' + dayNumber + '. Click "Plan Next Day" first.</div>';
      // create minimal centered map
      const fallbackCenter = [10.0236, 76.5656]; // Pezhakkapilly approx
      const map = L.map('map').setView(fallbackCenter, 11);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    } else {
      document.getElementById('map-info').innerHTML = '<strong>Planned route — Day ' + dayNumber + '</strong>';
      // ensure lat/lng exist for drawing; filter out stops without coords
      const latlngStops = stops.filter(s => s.lat !== null && s.lng !== null);

      const center = latlngStops.length ? [latlngStops[0].lat, latlngStops[0].lng] : [10.0236, 76.5656];
      const map = L.map('map').setView(center, 10);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      // draw polyline through all stops that have lat/lng (use order provided)
      const latlngs = [];
      for (let i=0;i<stops.length;i++){
        const s = stops[i];
        if (s.lat !== null && s.lng !== null) latlngs.push([s.lat, s.lng]);
      }

      if (latlngs.length >= 2) {
        const poly = L.polyline(latlngs, {color:'#E41E26', weight:4, opacity:0.85}).addTo(map);
        map.fitBounds(poly.getBounds(), {padding:[40,40]});
      }

      // add markers with numbering and popups
      for (let i=0;i<stops.length;i++){
        const s = stops[i];
        const label = (i === 0 ? 'HQ' : (i === stops.length-1 ? 'HQ' : String(i)));
        if (s.lat !== null && s.lng !== null) {
          const marker = L.marker([s.lat, s.lng], {
            title: s.name || s.address || label
          }).addTo(map);
          const popupHtml = `<div><strong>${s.name || ''}</strong><br><small>${s.address || ''}</small></div>`;
          marker.bindPopup(popupHtml);
        }
      }
    }
  </script>
</body>
</html>