<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Manager Registrations</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  {% include "_admin_nav.html" %}

  <main class="admin-wrap">
    <header class="admin-header">
      <h2 class="hello welcome-text">MANAGER REGISTRATIONS</h2>
    </header>

    <section class="card">
      <div id="mgrMessage"></div>

      <div class="filter-tabs" style="margin-bottom: 15px;">
        <button class="filter-tab active" onclick="showPending()" id="tabPending">Pending</button>
        <button class="filter-tab" onclick="showAll()" id="tabAll">All</button>
      </div>

      <div class="table-wrap">
        <table class="auditors-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Contact</th>
              <th>Branch</th>
              <th>Address</th>
              <th>Status</th>
              <th style="width:180px;">Actions</th>
            </tr>
          </thead>
          <tbody id="mgrRows">
            <tr><td colspan="6" style="text-align:center;padding:20px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    let currentMode = 'pending';

    function setActive(mode) {
      document.getElementById('tabPending').classList.toggle('active', mode === 'pending');
      document.getElementById('tabAll').classList.toggle('active', mode === 'all');
    }

    function showMessage(type, text) {
      const box = document.getElementById('mgrMessage');
      box.className = 'message ' + type;
      box.textContent = text;
      setTimeout(() => { box.textContent=''; box.className=''; }, 4000);
    }

    function escapeHtml(txt) {
      const d = document.createElement('div');
      d.textContent = String(txt ?? '');
      return d.innerHTML;
    }

    async function fetchManagers(url) {
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed');
        renderRows(data.items || []);
      } catch (e) {
        renderError(e.message);
      }
    }

    function renderError(msg) {
      document.getElementById('mgrRows').innerHTML =
        `<tr><td colspan="6" style="text-align:center;padding:20px;color:#dc3545;">${escapeHtml(msg)}</td></tr>`;
    }

    function renderRows(items) {
      const tbody = document.getElementById('mgrRows');
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;">No managers found.</td></tr>`;
        return;
      }
      tbody.innerHTML = items.map(m => {
        const statusBadge = m.approved
          ? '<span class="badge badge-visited">Approved</span>'
          : '<span class="badge badge-unvisited">Pending</span>';
        return `
          <tr>
            <td><strong>${escapeHtml(m.name)}</strong></td>
            <td>${m.contact_no ? escapeHtml(m.contact_no) : '<span class="empty-text">N/A</span>'}</td>
            <td>${m.branch_name ? escapeHtml(m.branch_name) : escapeHtml(m.branch_id || 'N/A')}</td>
            <td>${m.branch_address ? escapeHtml(m.branch_address) : '<span class="empty-text">No address</span>'}</td>
            <td>${statusBadge}</td>
            <td>
              ${m.approved
                ? `<button class="delete-btn" onclick="removeManager(${m.id})">Delete</button>`
                : `<div class="action-buttons">
                     <button class="btn-approve" onclick="approveManager(${m.id})">Approve</button>
                     <button class="btn-remove" onclick="removeManager(${m.id})">Remove</button>
                   </div>`
              }
            </td>
          </tr>
        `;
      }).join('');
    }

    function showPending() {
      currentMode = 'pending';
      setActive('pending');
      document.getElementById('mgrRows').innerHTML =
        '<tr><td colspan="6" style="text-align:center;padding:20px;">Loading...</td></tr>';
      fetchManagers('/api/admin/managers/pending');
    }

    function showAll() {
      currentMode = 'all';
      setActive('all');
      document.getElementById('mgrRows').innerHTML =
        '<tr><td colspan="6" style="text-align:center;padding:20px;">Loading...</td></tr>';
      fetchManagers('/api/admin/managers');
    }

    async function approveManager(id) {
      try {
        const res = await fetch(`/api/admin/managers/${id}/approve`, { method: 'POST' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Approve failed');
        showMessage('success', 'Manager approved');
        currentMode === 'pending' ? showPending() : showAll();
      } catch (e) {
        showMessage('error', e.message);
      }
    }

    async function removeManager(id) {
      if (!confirm('Remove this manager?')) return;
      try {
        const res = await fetch(`/api/admin/managers/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Delete failed');
        showMessage('success', 'Manager removed');
        currentMode === 'pending' ? showPending() : showAll();
      } catch (e) {
        showMessage('error', e.message);
      }
    }

    document.addEventListener('DOMContentLoaded', showPending);
  </script>
</body>
</html>