<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  {% include "_admin_nav.html" %}
  <main class="admin-wrap">
    <h2 class="hello welcome-text">WELCOME, {{ user.username }}</h2>

    <!-- Stats Card -->
    <section class="card stats-card">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">TOTAL AUDITORS</div>
          <div class="stat-value" id="totalAuditors">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-title">ACTIVE ROUTES</div>
          <div class="stat-value" id="activeRoutes">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-title">TOTAL BRANCHES</div>
          <div class="stat-value" id="totalBranches">0</div>
        </div>
      </div>
    </section>

    <div class="card" onclick="goToLiveTracking()">
        <h3>üìç Live Tracking</h3>
        <p>Track auditors in real-time</p>
    </div>

    <!-- Auditor Management -->
    <section class="card">
      <h3 style="color: #dc3545; margin-bottom: 20px;">Manage Auditors</h3>
      
      <div id="message"></div>

      <div style="margin-bottom: 30px;">
        <h4>Add New Auditor</h4>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="addAuditor(event)">Add Auditor</button>
      </div>

      <div class="table-wrap">
        <table class="auditors-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="auditorsBody">
            <tr><td colspan="4" style="text-align: center; padding: 20px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    function loadAuditors() {
      fetch('/api/auditors', { credentials: 'same-origin' })
        .then(response => {
          if (!response.ok) throw new Error('HTTP ' + response.status);
          const contentType = response.headers.get("content-type") || "";
          if (!contentType.includes("application/json")) throw new TypeError("Expected JSON, got " + contentType);
          return response.json();
        })
        .then(data => {
          if (!data.success) throw new Error(data.error || 'Failed to load');
          const auditors = data.auditors || [];
          document.getElementById('totalAuditors').textContent = auditors.length;
          
          const tbody = document.getElementById('auditorsBody');
          if (!auditors.length) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;">No auditors found.</td></tr>';
            return;
          }
          
          tbody.innerHTML = auditors.map(a => `
            <tr>
              <td>${escapeHtml(a.username)}</td>
              <td>${escapeHtml(a.role || 'auditor')}</td>
              <td>${escapeHtml(a.created_at || 'N/A')}</td>
              <td><button class="delete-btn" onclick="deleteAuditor(${a.id})">Delete</button></td>
            </tr>
          `).join('');
        })
        .catch(err => {
          console.error('Error loading auditors:', err);
          document.getElementById('auditorsBody').innerHTML = 
            `<tr><td colspan="4" style="text-align:center;padding:20px;color:#dc3545;">Error: ${escapeHtml(err.message)}</td></tr>`;
        });
    }

    function addAuditor(event) {
      event?.preventDefault?.();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) {
        alert('Username and password required');
        return;
      }

      const btn = event?.target || null;
      if (btn) btn.disabled = true;

      fetch('/admin/add_auditor', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ username, password })
      })
      .then(async r => {
        const ct = r.headers.get('content-type') || '';
        if (ct.includes('application/json')) return r.json();
        // If server returned a redirect or HTML, reload auditors list
        await loadAuditors();
        return { success: true, message: 'Auditor added (reloaded)' };
      })
      .then(data => {
        if (data && data.success) {
          alert(data.message || 'Auditor added');
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
          loadAuditors();
        } else {
          alert(data?.message || data?.error || 'Failed to add auditor');
        }
      })
      .catch(err => {
        alert('Error: ' + err.message);
      })
      .finally(() => {
        if (btn) btn.disabled = false;
      });
    }

    function deleteAuditor(id) {
      if (!confirm('Delete this auditor?')) return;
      fetch(`/admin/delete_auditor/${id}`, { method: 'DELETE', credentials: 'same-origin' })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          alert(data.message || data.error || (data.success ? 'Deleted' : 'Error'));
          if (data.success) loadAuditors();
        })
        .catch(err => alert('Error: ' + err.message));
    }

    function loadBranches() {
      fetch('/api/branches', { credentials: 'same-origin' })
        .then(r => r.json())
        .then(data => {
          if (data.success && data.branches) {
            document.getElementById('totalBranches').textContent = data.branches.length;
          }
        })
        .catch(err => console.error('Error loading branches:', err));
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text || '');
      return div.innerHTML;
    }

    function goToLiveTracking() {
        window.location.href = '/admin/live-tracking';
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAuditors();
      loadBranches();
    });
  </script>
</body>
</html>
