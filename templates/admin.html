<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  {% include "_admin_nav.html" %}
  <main class="admin-wrap">
    <header class="admin-header">
      <!-- changed: uppercase red welcome -->
      <h2 class="hello welcome-text">WELCOME, {{ user.username }}</h2>
    </header>

    <!-- Stats Card: three red cards -->
    <section class="card stats-card">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">TOTAL BRANCHES</div>
          <div class="stat-value" id="totalVal">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-title">VISITED</div>
          <div class="stat-value" id="visitedVal">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-title">REMAINING</div>
          <div class="stat-value" id="remainingVal">-</div>
        </div>
      </div>
    </section>

    <div class="card" onclick="goToLiveTracking()">
        <h3>üìç Live Tracking</h3>
        <p>Track auditors in real-time</p>
    </div>

    <!-- Auditor area visible on landing -->
    <section id="manage-auditors" class="auditor-area">
      <div class="grid two-col">
        <!-- Add Auditor Card -->
        <div class="auditor-card">
          <h3>Add Auditor</h3>
          <div id="msg"></div>
          <form onsubmit="event.preventDefault(); registerAuditor();">
            <div class="auditor-form-group">
              <label for="auser">Username</label>
              <input 
                  id="auser" 
                  type="text" 
                  required 
                  placeholder="Enter username"
              >
            </div>
            
            <div class="auditor-form-group">
              <label for="apass">Password</label>
              <input 
                  id="apass" 
                  type="password" 
                  required 
                  placeholder="Enter password"
              >
            </div>
            
            <button type="submit" class="auditor-submit">Create Auditor</button>
          </form>
        </div>

        <!-- Existing Auditors Card -->
        <div class="existing-auditors-card">
          <h3>Existing Auditors</h3>
          <div id="audMsg"></div>
          <div class="table-wrap">
            <table class="auditors-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody id="audTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Load statistics on page load
    async function loadStats() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed');
        document.getElementById('totalVal').textContent = data.total_branches;
        document.getElementById('visitedVal').textContent = data.visited_branches;
        document.getElementById('remainingVal').textContent = data.unvisited_branches;
      } catch (e) {
        console.error('Stats load failed', e);
      }
    }

    // Toggle visited branches list
    async function toggleVisitedList() {
      const listBox = document.getElementById('visitedList');
      const isVisible = listBox.style.display === 'block';
      if (isVisible) {
        listBox.style.display = 'none';
        return;
      }
      try {
        const res = await fetch('/api/visited-branches');
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed');
        const ul = document.getElementById('visitedItems');
        ul.innerHTML = '';
        if (data.items.length === 0) {
          ul.innerHTML = '<li>No branches visited yet.</li>';
        } else {
          data.items.forEach(b => {
            const li = document.createElement('li');
            li.textContent = `${b.name}${b.address ? ' - ' + b.address : ''}`;
            ul.appendChild(li);
          });
        }
        listBox.style.display = 'block';
      } catch (e) {
        console.error('Visited list load failed', e);
      }
    }

    // Register new auditor
    async function registerAuditor() {
      const username = document.getElementById('auser').value.trim();
      const password = document.getElementById('apass').value;
      const msg = document.getElementById('msg');
      msg.textContent = '';

      if (!username || !password) {
        msg.className = 'error';
        msg.textContent = 'Username and password are required';
        return;
      }

      try {
        const res = await fetch('/admin/register-auditor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) {
          msg.className = 'success';
          msg.textContent = data.message;
          document.getElementById('auser').value = '';
          document.getElementById('apass').value = '';
          loadAuditors();
        } else {
          msg.className = 'error';
          msg.textContent = data.error || 'Failed';
        }
      } catch(err) {
        msg.className = 'error';
        msg.textContent = 'Error: ' + err.message;
      }
    }

    // Load auditors list
    async function loadAuditors() {
      const table = document.getElementById('audTable');
      const audMsg = document.getElementById('audMsg');
      table.innerHTML = '';
      audMsg.textContent = '';
      try {
        const res = await fetch('/api/auditors');
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed');
        if (data.items.length === 0) {
            table.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">No auditors found.</td></tr>';
        } else {
          data.items.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${a.username}</td>
                <td><span class="status-${a.active ? 'active' : 'inactive'}">${a.active ? 'Active' : 'Inactive'}</span></td>
                <td>${a.created_at || ''}</td>
            `;
            table.appendChild(tr);
          });
        }
      } catch (e) {
        audMsg.className = 'error';
        audMsg.textContent = 'Failed to load auditors: ' + e.message;
      }
    }

    function goToLiveTracking() {
        window.location.href = '/admin/live-tracking';
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadAuditors();
      const visitedCard = document.getElementById('visitedCard');
      if (visitedCard) visitedCard.addEventListener('click', toggleVisitedList);
    });
  </script>
</body>
</html>
